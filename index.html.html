<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>School AC Unit Planner</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #e2e8f0;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #94a3b8;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #64748b;
        }
        .filter-button.active {
            @apply bg-blue-700; /* Darker blue when active */
        }
        /* Modal styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 0.75rem; /* rounded-xl */
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1); /* shadow-lg */
            width: 90%;
            max-width: 500px;
            text-align: center;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col p-4 sm:p-6 lg:p-8">
    <div class="max-w-7xl mx-auto w-full">
        <!-- Header -->
        <header class="bg-gradient-to-r from-blue-500 to-indigo-600 text-white p-6 rounded-xl shadow-lg mb-8 flex flex-col sm:flex-row items-center justify-center sm:justify-start">
            <!-- Logo container -->
            <div class="mb-4 sm:mb-0 sm:mr-6">
                <img src="https://rnit-tesda.org/_next/image?url=%2F_next%2Fstatic%2Fmedia%2FRNIT-logo.d5ef6240.webp&w=64&q=75" alt="Company Logo" alt="Company Logo" class="h-20 w-20 rounded-full border-2 border-white shadow-md object-cover">
            </div>
            <!-- Title and Trainer Info -->
            <div class="text-center sm:text-left">
                <h1 class="text-3xl sm:text-4xl font-bold mb-2">Romblon National Institute of Technology AC Unit Management</h1>
                <p class="text-lg">Engr. Nico Galisanao - RAC Servicing NC II Trainer.</p>
            </div>
        </header>

        <!-- Loading Indicator -->
        <div id="loading" class="flex justify-center items-center h-48" style="display: none;">
            <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-blue-500"></div>
            <p class="ml-4 text-lg text-gray-700">Loading data...</p>
        </div>

        <!-- User ID Display -->
        <div id="user-info" class="bg-gray-100 p-4 rounded-lg shadow-sm mb-6 text-sm text-gray-600 break-words" style="display: none;">
            <p><strong>Your User ID:</strong> <span id="user-id-display"></span></p>
            <p class="text-xs mt-1">This ID is used to manage your private data.</p>
        </div>

        <!-- Dashboard Section -->
        <section class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
            <div class="bg-white p-6 rounded-xl shadow-md flex items-center justify-between">
                <div>
                    <h2 class="text-lg font-semibold text-gray-700">Total AC Units</h2>
                    <p id="total-units" class="text-4xl font-bold text-blue-600 mt-2">0</p>
                </div>
                <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 text-blue-400 opacity-70" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 3v1m0 16v1m9-9h1M3 12H2M15 9.3V7.5A2.5 2.5 0 0012.5 5h-1A2.5 2.5 0 009 7.5v1.8m6 0a.75.75 0 11-1.5 0 .75.75 0 011.5 0zm-6 0a.75.75 0 11-1.5 0 .75.75 0 011.5 0zM12 15a4 4 0 100-8 4 4 0 000 8z" />
                </svg>
            </div>
            <div class="bg-white p-6 rounded-xl shadow-md flex items-center justify-between">
                <div>
                    <h2 class="text-lg font-semibold text-gray-700">Needs Maintenance Soon</h2>
                    <p id="urgent-maintenance" class="text-4xl font-bold text-yellow-600 mt-2">0</p>
                </div>
                <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 text-yellow-400 opacity-70" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                </svg>
            </div>
            <div class="bg-white p-6 rounded-xl shadow-md flex items-center justify-between">
                <div>
                    <h2 class="text-lg font-semibold text-gray-700">Overdue Maintenance</h2>
                    <p id="overdue-maintenance" class="text-4xl font-bold text-red-600 mt-2">0</p>
                </div>
                <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 text-red-400 opacity-70" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
            </div>
            <div class="bg-white p-6 rounded-xl shadow-md flex items-center justify-between">
                <div>
                    <h2 class="text-lg font-semibold text-gray-700">Units Under Repair</h2>
                    <p id="repair-units" class="text-4xl font-bold text-gray-600 mt-2">0</p>
                </div>
                <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 text-gray-400 opacity-70" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.332 2.572-1.065z" />
                    <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                </svg>
            </div>
        </section>

        <!-- AC Units List -->
        <section class="bg-white p-6 rounded-xl shadow-md mb-8">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4">AC Units List</h2>

            <!-- Filter Buttons (Tabs) -->
            <div class="flex flex-wrap gap-2 mb-4" id="filter-buttons">
                <button class="filter-button px-4 py-2 rounded-lg bg-blue-600 text-white font-medium shadow-sm transition-colors duration-200 active" data-filter="all">All Units</button>
                <button class="filter-button px-4 py-2 rounded-lg bg-blue-600 text-white font-medium shadow-sm transition-colors duration-200" data-filter="operational">Operational</button>
                <button class="filter-button px-4 py-2 rounded-lg bg-blue-600 text-white font-medium shadow-sm transition-colors duration-200" data-filter="under_repair">Under Repair</button>
                <button class="filter-button px-4 py-2 rounded-lg bg-yellow-600 text-white font-medium shadow-sm transition-colors duration-200" data-filter="needs_maintenance_soon">Needs Maintenance Soon</button>
                <button class="filter-button px-4 py-2 rounded-lg bg-red-600 text-white font-medium shadow-sm transition-colors duration-200" data-filter="overdue_maintenance">Overdue Maintenance</button>
            </div>

            <div class="mb-4">
                <input type="text" id="search-input" placeholder="Search by Room Name, Type of Unit, Brand, or Action Taken..."
                       class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
            </div>
            <div class="overflow-x-auto rounded-lg border border-gray-200">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Room/Location</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type of Unit</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Brand/HP</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Last Maintenance</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Next Maintenance</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Last Action Taken</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                            <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="ac-units-table-body" class="bg-white divide-y divide-gray-200">
                        <!-- AC units will be loaded here -->
                        <tr>
                            <td colspan="8" class="px-6 py-4 whitespace-nowrap text-center text-gray-500" id="no-units-message">No AC units added yet.</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </section>

        <!-- Button to toggle Add/Edit AC Unit Form -->
        <div class="flex justify-center mb-8">
            <button id="toggle-add-form-button" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-8 rounded-lg shadow-lg transition duration-300 ease-in-out transform hover:scale-105">
                Add New AC Unit
            </button>
        </div>

        <!-- Add/Edit AC Unit Form (Moved to bottom and initially hidden) -->
        <section id="admin-form-section" class="bg-white p-6 rounded-xl shadow-md mb-8" style="display: none;">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4" id="form-title">Add New AC Unit</h2>
            <form id="ac-unit-form" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <div>
                    <label for="room-name" class="block text-sm font-medium text-gray-700 mb-1">Room Name/Location</label>
                    <input type="text" id="room-name" placeholder="e.g., Classroom 101, Library" required
                           class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label for="type-of-unit" class="block text-sm font-medium text-gray-700 mb-1">Type of Unit (Optional)</label>
                    <select id="type-of-unit"
                            class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                        <option value="">Select Type</option>
                        <option value="Split Type">Split Type</option>
                        <option value="Window Type">Window Type</option>
                        <option value="Centralized">Centralized</option>
                        <option value="Portable">Portable</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div>
                    <label for="brand-hp" class="block text-sm font-medium text-gray-700 mb-1">Brand/HP (Optional)</label>
                    <input type="text" id="brand-hp" placeholder="e.g., Carrier 1.5HP, Daikin 2.0T"
                           class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label for="last-maintenance" class="block text-sm font-medium text-gray-700 mb-1">Last Maintenance Date</label>
                    <input type="date" id="last-maintenance" required
                           class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label for="next-maintenance" class="block text-sm font-medium text-gray-700 mb-1">Next Scheduled Maintenance Date</label>
                    <input type="date" id="next-maintenance" required
                           class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label for="last-action-taken" class="block text-sm font-medium text-gray-700 mb-1">Last Action Taken (Optional)</label>
                    <input type="text" id="last-action-taken" placeholder="e.g., Filter cleaned, Compressor replaced"
                           class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label for="status" class="block text-sm font-medium text-gray-700 mb-1">Unit Status</label>
                    <select id="status" required
                            class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                        <option value="Operational">Operational</option>
                        <option value="Under Repair">Under Repair</option>
                    </select>
                </div>
                <div class="md:col-span-2 lg:col-span-3 flex justify-end gap-2 mt-2">
                    <button type="submit" id="submit-button"
                            class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-6 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105">
                        Add AC Unit
                    </button>
                    <button type="button" id="cancel-edit-button" style="display:none;"
                            class="bg-gray-400 hover:bg-gray-500 text-white font-semibold py-2 px-6 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105">
                        Cancel Edit
                    </button>
                </div>
            </form>
        </section>
    </div>

    <!-- Custom Modal for Maintenance Input -->
    <div id="maintenance-modal-overlay" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <h3 class="text-xl font-semibold mb-4">Record Maintenance Action</h3>
            <p class="text-gray-700 mb-4">What action was performed on this AC unit?</p>
            <input type="text" id="maintenance-action-input" placeholder="e.g., Filter cleaned, Refrigerant recharged"
                   class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500 mb-6">
            <div class="flex justify-center gap-4">
                <button id="confirm-maintenance-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-6 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105">
                    Confirm
                </button>
                <button id="cancel-maintenance-btn" class="bg-gray-400 hover:bg-gray-500 text-white font-semibold py-2 px-6 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105">
                    Cancel
                </button>
            </div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, deleteDoc, onSnapshot, query, where, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase Configuration (provided by environment or fallback)
        // IMPORTANT: If running this file locally outside the Canvas, you MUST replace
        // these placeholder values with your actual Firebase project configuration.
        // You can find your project config in your Firebase console under Project settings -> General.
        // Also, ensure your Firestore Security Rules allow read access for authenticated users.
        // For example:
        // rules_version = '2';
        // service cloud.firestore {
        //   match /databases/{database}/documents {
        //     match /artifacts/{appId}/public/data/{document=**} {
        //       allow read, write: if request.auth != null;
        //     }
        //   }
        // }
        const defaultAppId = '1:448754123689:web:2f2f7086da0dd7672c7ab8'; // Replace with a unique ID for your app
        const defaultFirebaseConfig = {
    apiKey: "AIzaSyA0k3YOl8lgdmK7_s5juq3L4Qo0xgyD1Hk",
    authDomain: "rnit-ac-planner-723c2.firebaseapp.com",
    projectId: "rnit-ac-planner-723c2",
    storageBucket: "rnit-ac-planner-723c2.firebasestorage.app",
    messagingSenderId: "448754123689",
    appId: "1:448754123689:web:2f2f7086da0dd7672c7ab8",
    measurementId: "G-RDDLJ0NFBW"
  };

        const appId = typeof __app_id !== 'undefined' ? __app_id : defaultAppId;
        const firebaseConfig = typeof __firebase_config !== 'undefined' && Object.keys(JSON.parse(__firebase_config)).length > 0
                               ? JSON.parse(__firebase_config)
                               : defaultFirebaseConfig;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null; 

        // Initialize Firebase
        let app;
        let db;
        let auth;
        let currentUserId = null;
        let editingDocId = null; // To store the ID of the document being edited
        let allAcUnits = []; // Store all AC units fetched from Firestore
        let currentFilter = 'all'; // Default filter: 'all', 'operational', 'under_repair', 'needs_maintenance_soon', 'overdue_maintenance'
        let currentUnitIdForMaintenance = null; // NEW: To store the ID of the unit being marked for maintenance

        const loadingIndicator = document.getElementById('loading');
        const userInfoDiv = document.getElementById('user-info');
        const userIdDisplay = document.getElementById('user-id-display');
        const adminFormSection = document.getElementById('admin-form-section');
        const acUnitForm = document.getElementById('ac-unit-form');
        const roomNameInput = document.getElementById('room-name');
        const typeOfUnitInput = document.getElementById('type-of-unit');
        const brandHpInput = document.getElementById('brand-hp');
        const lastMaintenanceInput = document.getElementById('last-maintenance');
        const nextMaintenanceInput = document.getElementById('next-maintenance');
        const lastActionTakenInput = document.getElementById('last-action-taken');
        const statusInput = document.getElementById('status');
        const submitButton = document.getElementById('submit-button');
        const cancelButton = document.getElementById('cancel-edit-button');
        const formTitle = document.getElementById('form-title');
        const acUnitsTableBody = document.getElementById('ac-units-table-body');
        const noUnitsMessage = document.getElementById('no-units-message');
        const searchInput = document.getElementById('search-input');
        const totalUnitsDisplay = document.getElementById('total-units');
        const urgentMaintenanceDisplay = document.getElementById('urgent-maintenance');
        const overdueMaintenanceDisplay = document.getElementById('overdue-maintenance');
        const repairUnitsDisplay = document.getElementById('repair-units');
        const filterButtonsContainer = document.getElementById('filter-buttons');
        const toggleAddFormButton = document.getElementById('toggle-add-form-button');

        // NEW: Modal elements
        const maintenanceModalOverlay = document.getElementById('maintenance-modal-overlay');
        const maintenanceActionInput = document.getElementById('maintenance-action-input');
        const confirmMaintenanceBtn = document.getElementById('confirm-maintenance-btn');
        const cancelMaintenanceBtn = document.getElementById('cancel-maintenance-btn');

        /**
         * Initializes Firebase and authenticates the user.
         */
        async function initializeFirebaseAndAuth() {
            loadingIndicator.style.display = 'flex';
            try {
                // Check if the placeholder Firebase config is still in use
                if (firebaseConfig.projectId === "YOUR_PROJECT_ID") {
                    console.warn("WARNING: Using placeholder Firebase configuration. Data will not persist. Please replace 'YOUR_API_KEY', 'YOUR_PROJECT_ID', etc. with your actual Firebase project details for persistent storage.");
                }

                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Sign in with custom token if available, otherwise anonymously
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        currentUserId = user.uid;
                        userIdDisplay.textContent = currentUserId;
                        userInfoDiv.style.display = 'block';
                        setupAcUnitsListener();
                    } else {
                        currentUserId = null;
                        userIdDisplay.textContent = 'N/A';
                        userInfoDiv.style.display = 'none';
                        console.log("No user signed in.");
                        acUnitsTableBody.innerHTML = `<tr><td colspan="8" class="px-6 py-4 whitespace-nowrap text-center text-gray-500">Please sign in to view your AC units.</td></tr>`;
                        updateDashboardStats([]);
                    }
                    loadingIndicator.style.display = 'none';
                });

            } catch (error) {
                console.error("Error initializing Firebase or authenticating:", error);
                alert("Failed to initialize the application. Please try again later. Check the console for more details.");
                loadingIndicator.style.display = 'none';
            }
        }

        /**
         * Sets up a real-time listener for AC units in Firestore.
         */
        function setupAcUnitsListener() {
            const acUnitsCollectionRef = collection(db, `artifacts/${appId}/public/data/ac_units`);

            onSnapshot(acUnitsCollectionRef, (snapshot) => {
                allAcUnits = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const typeOfUnit = data.typeOfUnit || data.unitId || null; // Backward compatibility for old 'unitId'
                    allAcUnits.push({ id: doc.id, ...data, typeOfUnit: typeOfUnit });
                });
                allAcUnits.sort((a, b) => new Date(a.nextMaintenance) - new Date(b.nextMaintenance));
                displayAcUnits();
                updateDashboardStats(allAcUnits);
            }, (error) => {
                console.error("Error fetching AC units:", error);
                alert("Failed to load AC units. Please check your internet connection.");
            });
        }

        /**
         * Determines if an AC unit needs maintenance soon or is overdue.
         * @param {Object} unit - The AC unit object.
         * @returns {string|null} 'needs_soon', 'overdue', or null if operational and on schedule.
         */
        function getMaintenanceStatusForFilter(unit) {
            if (unit.status === 'Under Repair') {
                return null; // Under repair units are not considered for maintenance urgency filters
            }

            const nextMaintenanceDate = new Date(unit.nextMaintenance);
            const today = new Date();
            today.setHours(0, 0, 0, 0); // Normalize today's date

            if (nextMaintenanceDate < today) {
                return 'overdue_maintenance';
            } else {
                const daysUntilMaintenance = Math.ceil((nextMaintenanceDate - today) / (1000 * 60 * 60 * 24));
                if (daysUntilMaintenance <= 30) {
                    return 'needs_maintenance_soon';
                }
            }
            return null; // On schedule
        }


        /**
         * Displays the list of AC units in the table based on the current filter and search term.
         */
        function displayAcUnits() {
            acUnitsTableBody.innerHTML = '';

            const searchTerm = searchInput.value.toLowerCase();
            let unitsToDisplay = allAcUnits;

            // Apply filter based on currentFilter
            if (currentFilter === 'operational') {
                unitsToDisplay = unitsToDisplay.filter(unit => unit.status === 'Operational');
            } else if (currentFilter === 'under_repair') {
                unitsToDisplay = unitsToDisplay.filter(unit => unit.status === 'Under Repair');
            } else if (currentFilter === 'needs_maintenance_soon') {
                unitsToDisplay = unitsToDisplay.filter(unit => getMaintenanceStatusForFilter(unit) === 'needs_maintenance_soon');
            } else if (currentFilter === 'overdue_maintenance') {
                unitsToDisplay = unitsToDisplay.filter(unit => getMaintenanceStatusForFilter(unit) === 'overdue_maintenance');
            }


            unitsToDisplay = unitsToDisplay.filter(unit =>
                unit.roomName.toLowerCase().includes(searchTerm) ||
                (unit.typeOfUnit && unit.typeOfUnit.toLowerCase().includes(searchTerm)) ||
                (unit.brandHp && unit.brandHp.toLowerCase().includes(searchTerm)) ||
                (unit.lastActionTaken && unit.lastActionTaken.toLowerCase().includes(searchTerm)) // Include new field in search
            );

            if (unitsToDisplay.length === 0) {
                const messageRow = document.createElement('tr');
                messageRow.innerHTML = `<td colspan="8" class="px-6 py-4 whitespace-nowrap text-center text-gray-500">No matching AC units found for the current filter.</td>`;
                acUnitsTableBody.appendChild(messageRow);
                return;
            }

            unitsToDisplay.forEach(unit => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';

                const nextMaintenanceDate = new Date(unit.nextMaintenance);
                const today = new Date();
                today.setHours(0, 0, 0, 0);

                let statusClass = '';
                let statusText = unit.status;

                // Determine maintenance urgency text and class
                if (unit.status === 'Operational') {
                    const daysUntilMaintenance = Math.ceil((nextMaintenanceDate - today) / (1000 * 60 * 60 * 24));
                    if (nextMaintenanceDate < today) {
                        statusClass = 'text-red-600 font-bold';
                        statusText = 'OVERDUE';
                    } else if (daysUntilMaintenance <= 30) {
                        statusClass = 'text-yellow-600 font-bold';
                        statusText = `${daysUntilMaintenance} Days Left`;
                    } else {
                        statusClass = 'text-green-600';
                        statusText = 'On Schedule';
                    }
                } else if (unit.status === 'Under Repair') {
                    statusClass = 'text-gray-600 font-bold';
                }

                // Determine if 'Mark as Maintained' button should be shown
                const showMarkAsMaintainedButton = (getMaintenanceStatusForFilter(unit) !== null || unit.status === 'Under Repair');

                const actionButtonsHtml = `
                    <button data-id="${unit.id}" class="edit-btn text-indigo-600 hover:text-indigo-900 transition duration-150 ease-in-out">
                        Edit
                    </button>
                    <button data-id="${unit.id}" class="delete-btn text-red-600 hover:text-red-900 transition duration-150 ease-in-out">
                        Delete
                    </button>
                    ${showMarkAsMaintainedButton ? `
                        <button data-id="${unit.id}" class="mark-maintained-btn bg-green-500 hover:bg-green-600 text-white py-1 px-3 rounded-md text-xs transition duration-150 ease-in-out ml-2">
                            Mark as Maintained
                        </button>` : ''}
                `;

                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 rounded-l-lg">${unit.roomName}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${unit.typeOfUnit || 'N/A'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${unit.brandHp || 'N/A'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${unit.lastMaintenance}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${unit.nextMaintenance}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${unit.lastActionTaken || 'N/A'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm ${statusClass}">${statusText}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium space-x-2 rounded-r-lg">
                        ${actionButtonsHtml}
                    </td>
                `;
                acUnitsTableBody.appendChild(row);
            });

            addEventListenersToButtons();
        }

        /**
         * Updates the dashboard statistics.
         * @param {Array<Object>} acUnits - Array of AC unit objects.
         */
        function updateDashboardStats(acUnits) {
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            let urgentCount = 0;
            let overdueCount = 0;
            let repairCount = 0;

            acUnits.forEach(unit => {
                if (unit.status === 'Under Repair') {
                    repairCount++;
                } else {
                    const nextMaintenanceDate = new Date(unit.nextMaintenance);
                    nextMaintenanceDate.setHours(0, 0, 0, 0);

                    if (nextMaintenanceDate < today) {
                        overdueCount++;
                    } else {
                        const daysUntilMaintenance = Math.ceil((nextMaintenanceDate - today) / (1000 * 60 * 60 * 24));
                        if (daysUntilMaintenance <= 30) {
                            urgentCount++;
                        }
                    }
                }
            });

            totalUnitsDisplay.textContent = acUnits.length;
            urgentMaintenanceDisplay.textContent = urgentCount;
            overdueMaintenanceDisplay.textContent = overdueCount;
            repairUnitsDisplay.textContent = repairCount;
        }

        /**
         * Adds event listeners to edit, delete, and now 'Mark as Maintained' buttons.
         */
        function addEventListenersToButtons() {
            document.querySelectorAll('.edit-btn').forEach(button => {
                button.onclick = (e) => editAcUnit(e.target.dataset.id);
            });
            document.querySelectorAll('.delete-btn').forEach(button => {
                button.onclick = (e) => deleteAcUnit(e.target.dataset.id);
            });
            document.querySelectorAll('.mark-maintained-btn').forEach(button => {
                button.onclick = (e) => showMaintenanceModal(e.target.dataset.id); // Changed to show modal
            });
        }

        /**
         * Handles the submission of the AC unit form (add or update).
         */
        acUnitForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            const roomName = roomNameInput.value.trim();
            const typeOfUnit = typeOfUnitInput.value.trim();
            const brandHp = brandHpInput.value.trim();
            const lastMaintenance = lastMaintenanceInput.value;
            const nextMaintenance = nextMaintenanceInput.value;
            const lastActionTaken = lastActionTakenInput.value.trim();
            const status = statusInput.value;

            if (!roomName || !lastMaintenance || !nextMaintenance || !status) {
                alert("Please fill in all required fields.");
                return;
            }

            const acUnitData = {
                roomName,
                typeOfUnit: typeOfUnit || null,
                brandHp: brandHp || null,
                lastMaintenance,
                nextMaintenance,
                lastActionTaken: lastActionTaken || null,
                status,
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString(),
                userId: currentUserId
            };

            try {
                const collectionPath = `artifacts/${appId}/public/data/ac_units`;

                if (editingDocId) {
                    const docRef = doc(db, collectionPath, editingDocId);
                    await updateDoc(docRef, { ...acUnitData, updatedAt: new Date().toISOString() });
                    alert("AC Unit updated successfully!");
                } else {
                    const collectionRef = collection(db, collectionPath);
                    await addDoc(collectionRef, acUnitData);
                    alert("AC Unit added successfully!");
                }
                resetForm();
                adminFormSection.style.display = 'none'; // Hide form after submission
            } catch (error) {
                console.error("Error saving AC unit:", error);
                alert("Failed to save AC unit. Please try again.");
            }
        });

        /**
         * Fills the form with data for editing an AC unit.
         */
        async function editAcUnit(id) {
            try {
                const collectionPath = `artifacts/${appId}/public/data/ac_units`;
                const docRef = doc(db, collectionPath, id);
                const snapshot = await getDoc(docRef);

                if (snapshot.exists()) {
                    const data = snapshot.data();
                    roomNameInput.value = data.roomName;
                    typeOfUnitInput.value = data.typeOfUnit || data.unitId || '';
                    brandHpInput.value = data.brandHp || '';
                    lastMaintenanceInput.value = data.lastMaintenance;
                    nextMaintenanceInput.value = data.nextMaintenance;
                    lastActionTakenInput.value = data.lastActionTaken || '';
                    statusInput.value = data.status || 'Operational';

                    editingDocId = id;
                    formTitle.textContent = 'Edit AC Unit';
                    submitButton.textContent = 'Update AC Unit';
                    cancelButton.style.display = 'inline-block';
                    adminFormSection.style.display = 'block'; // Show form when editing
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                } else {
                    alert("AC Unit not found.");
                }
            } catch (error) {
                console.error("Error fetching AC unit for edit:", error);
                alert("Failed to load AC unit for editing.");
            }
        }

        /**
         * Deletes an AC unit from Firestore.
         */
        async function deleteAcUnit(id) {
            if (confirm("Are you sure you want to delete this AC unit record?")) {
                try {
                    const collectionPath = `artifacts/${appId}/public/data/ac_units`;
                    const docRef = doc(db, collectionPath, id);
                    await deleteDoc(docRef);
                    alert("AC Unit deleted successfully!");
                    resetForm();
                    adminFormSection.style.display = 'none'; // Hide form after deletion
                } catch (error) {
                    console.error("Error deleting AC unit:", error);
                    alert("Failed to delete AC unit. Please try again.");
                }
            }
        }

        /**
         * NEW: Function to show the maintenance input modal.
         * @param {string} unitId - The ID of the AC unit to mark as maintained.
         */
        function showMaintenanceModal(unitId) {
            currentUnitIdForMaintenance = unitId; // Store the unit ID
            maintenanceActionInput.value = ''; // Clear previous input
            maintenanceModalOverlay.style.display = 'flex'; // Show the modal
        }

        /**
         * NEW: Function to hide the maintenance input modal.
         */
        function hideMaintenanceModal() {
            maintenanceModalOverlay.style.display = 'none'; // Hide the modal
            currentUnitIdForMaintenance = null; // Clear the stored unit ID
            maintenanceActionInput.value = ''; // Clear input
        }

        /**
         * NEW: Handles the confirmation from the maintenance modal.
         */
        confirmMaintenanceBtn.addEventListener('click', async () => {
            const actionTaken = maintenanceActionInput.value.trim();
            if (!actionTaken) {
                alert("Please describe the maintenance action performed.");
                return;
            }

            if (currentUnitIdForMaintenance) {
                try {
                    const collectionPath = `artifacts/${appId}/public/data/ac_units`;
                    const docRef = doc(db, collectionPath, currentUnitIdForMaintenance);

                    const today = new Date();
                    const lastMaintenanceNew = today.toISOString().split('T')[0];

                    const nextMaintenanceNewDate = new Date(today);
                    nextMaintenanceNewDate.setMonth(nextMaintenanceNewDate.getMonth() + 6);
                    const nextMaintenanceNew = nextMaintenanceNewDate.toISOString().split('T')[0];

                    await updateDoc(docRef, {
                        lastMaintenance: lastMaintenanceNew,
                        nextMaintenance: nextMaintenanceNew,
                        status: 'Operational', // Assuming maintenance makes it operational
                        lastActionTaken: actionTaken, // Use the user's input
                        updatedAt: new Date().toISOString()
                    });
                    alert("AC Unit marked as maintained successfully!");
                    hideMaintenanceModal(); // Hide modal on success
                } catch (error) {
                    console.error("Error marking AC unit as maintained:", error);
                    alert("Failed to mark AC unit as maintained. Please try again.");
                }
            }
        });

        // NEW: Event listener for the cancel button in the modal
        cancelMaintenanceBtn.addEventListener('click', hideMaintenanceModal);


        /**
         * Resets the form to its initial state (for adding new units).
         */
        function resetForm() {
            acUnitForm.reset();
            statusInput.value = 'Operational';
            lastActionTakenInput.value = '';
            editingDocId = null;
            formTitle.textContent = 'Add New AC Unit';
            submitButton.textContent = 'Add AC Unit';
            cancelButton.style.display = 'none';
        }

        // Event listener for cancel edit button
        cancelButton.addEventListener('click', () => {
            resetForm();
            adminFormSection.style.display = 'none'; // Hide form when canceling
        });

        // Event listener for search input
        searchInput.addEventListener('input', () => {
            displayAcUnits();
        });

        // Event listener for filter buttons (tabs)
        filterButtonsContainer.addEventListener('click', (e) => {
            if (e.target.classList.contains('filter-button')) {
                document.querySelectorAll('.filter-button').forEach(button => {
                    button.classList.remove('active');
                });
                e.target.classList.add('active');

                currentFilter = e.target.dataset.filter;
                displayAcUnits();
            }
        });

        // Event listener for the new toggle button
        toggleAddFormButton.addEventListener('click', () => {
            if (adminFormSection.style.display === 'none' || adminFormSection.style.display === '') {
                adminFormSection.style.display = 'block';
                resetForm(); // Ensure form is clean for new entry
                window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' }); // Scroll to bottom
            } else {
                adminFormSection.style.display = 'none';
                resetForm(); // Reset form if hidden while editing
            }
        });

        // Initialize the application when the window loads
        window.onload = initializeFirebaseAndAuth;
    </script>
</body>
</html>
